name: Auto Update Jiostar M3U 

on:
  schedule:

    - cron: "0 */2 * * *"  
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Run PHP script
        env:
          M3U_URL: ${{ secrets.M3U_URL }}
        run: |
          php <<'PHP'
          <?php
          error_reporting(E_ALL);
          ini_set('display_errors', 1);

          $url = getenv('M3U_URL');
          $data = @file_get_contents($url);

          if (!$data) {
              echo "Failed to fetch M3U file.";
              exit(1);
          }

          $lines = explode("\n", trim($data));
          $channels = [];
          $cookies = [];
          $current = [];

          foreach ($lines as $line) {
              $line = trim($line);

              if (strpos($line, '#EXTINF') === 0) {
                  preg_match('/tvg-id="([^"]*)"/', $line, $id);
                  preg_match('/group-title="([^"]*)"/', $line, $group);
                  preg_match('/tvg-logo="([^"]*)"/', $line, $logo);
                  preg_match('/,(.*)$/', $line, $name);
                  $current = [
                      'tvg_id' => $id[1] ?? '',
                      'group'  => $group[1] ?? '',
                      'logo'   => $logo[1] ?? '',
                      'name'   => $name[1] ?? '',
                      'url'    => '',
                      'cookie' => '',
                      'license_key' => ''
                  ];
              }

              elseif (strpos($line, '#KODIPROP:inputstream.adaptive.license_key=') === 0) {
                  $license = trim(str_replace('#KODIPROP:inputstream.adaptive.license_key=', '', $line));
                  $current['license_key'] = $license;
              }

              elseif (strpos($line, '#EXTHTTP:') === 0) {
                  if (preg_match('/"cookie":"([^"]+)"/', $line, $cookieMatch)) {
                      $cookie = $cookieMatch[1];
                      $current['cookie'] = $cookie;
                      $cookies[] = [
                          'name' => $current['name'] ?? '',
                          'cookie' => $cookie
                      ];
                  }
              }

              elseif (preg_match('/^https?:\/\//', $line)) {
                  $current['url'] = $line;
                  if (!empty($current['name'])) {
                      $channels[] = $current;
                  }
                  $current = [];
              }
          }

    
          file_put_contents('channels.json', json_encode($channels, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES));

          // Generate cookie.json
          file_put_contents('cookie.json', json_encode($cookies, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES));

          $m3u = '#EXTM3U x-tvg-url="https://avkb.short.gy/jioepg.xml.gz"' . "\n";
          foreach ($channels as $c) {
              $m3u .= sprintf('#EXTINF:-1 tvg-id="%s" group-title="%s" tvg-logo="%s",%s', 
                  $c['tvg_id'], $c['group'], $c['logo'], $c['name']
              ) . "\n";
              $m3u .= $c['url'] . "\n";
          }
          file_put_contents('channels.m3u', $m3u);

         
          $api_data = [];
          foreach ($channels as $c) {
              $api_data[] = [
                  'id'       => $c['tvg_id'],
                  'name'     => $c['name'],
                  'mpd'      => $c['url'], 
                  'cookie'   => $c['cookie'],
                  'logo'     => $c['logo'],
                  'clearkey' => $c['license_key']
              ];
          }
          file_put_contents('api.json', json_encode($api_data, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES));

          echo " All files generated successfully.\n";
          PHP

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          # All generated files are included here
          git add channels.json cookie.json channels.m3u api.json 
          git commit -m "ðŸ”„ Auto updated Jiostar M3U data" || echo "No changes to commit"
          git push
