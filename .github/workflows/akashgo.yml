name: Auto Update AkashGO Data

on:
  schedule:
    - cron: "0 */10 * * *"   
  workflow_dispatch:

jobs:
  update-akashgo:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Fetch and Build AkashGO data.json
        run: |
          echo "ðŸ“¡ Fetching AkashGO live channels..."
          BASE_URL="https://kong.akash-go.com"
          SEARCH_URL="$BASE_URL/search-connector/pub/freemium/search/livedata?genre=*&limit=25&offset=0"

          # Fetch live list
          curl -s "$SEARCH_URL" -o livedata.json
          echo "[" > data.json

          IDS=$(jq -r '.data.contentList[].id' livedata.json)

          for ID in $IDS; do
            DETAIL_URL="$BASE_URL/content-detail/pub/api/v6/channels/$ID"
            DETAIL_JSON=$(curl -s "$DETAIL_URL")

            NAME=$(echo "$DETAIL_JSON" | jq -r '.data.channelMeta.channelName')
            LOGO=$(echo "$DETAIL_JSON" | jq -r '.data.channelMeta.logo')
            HLS=$(echo "$DETAIL_JSON" | jq -r '.data.channelMeta.nonProtectedHlsConsumerUrl')
            DASH=$(echo "$DETAIL_JSON" | jq -r '.data.channelMeta.protectedDashWidevineConsumerUrl')
            LICENSE=$(echo "$DETAIL_JSON" | jq -r '.data.channelMeta.dashWidevineLicenseUrl')

            # Skip if no valid name
            if [ "$NAME" = "null" ] || [ -z "$NAME" ]; then
              continue
            fi

            if [ "$HLS" != "null" ] && [ -n "$HLS" ]; then
              jq -n --arg group "AkashGO" \
                    --arg logo "$LOGO" \
                    --arg name "$NAME" \
                    --arg url "$HLS" \
                    '{
                      group: $group,
                      logo: $logo,
                      mobile: "on",
                      name: $name,
                      premium: false,
                      source: {
                        headers: { Cookie: "" },
                        url: $url
                      },
                      status: "on",
                      tv: "off"
                    }' >> temp.json
            elif [ "$DASH" != "null" ] && [ -n "$DASH" ]; then
              # Extract short contentId for license
              SHORT_ID=$(echo "$LICENSE" | grep -oE '[a-f0-9-]{8,}$' | cut -c1-12)

              jq -n --arg name "$NAME" \
                    --arg logo "$LOGO" \
                    --arg url "$DASH" \
                    --arg shortid "$SHORT_ID" \
                    '{
                      name: $name,
                      logo: $logo,
                      group: "AkashGO",
                      source: {
                        type: "dash",
                        url: $url,
                        license: {
                          type: "widevine",
                          url: ("https://dth.nettv.fun/lic.php?ic=" + $shortid)
                        },
                        headers: {
                          "User-Agent": "Mozilla/5.0 (Linux; Android 9; Redmi S2 Build/PKQ1.181203.001)",
                          "Referer": "",
                          "Origin": "",
                          "Cookie": ""
                        }
                      }
                    }' >> temp.json
            fi

            echo "," >> temp.json
          done

          # Combine JSON array
          cat temp.json | sed '$ s/,$//' >> data.json
          echo "]" >> data.json

          # Validate final JSON
          jq . data.json > verified.json && mv verified.json data.json

      - name: Commit and Push Updated data.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json
          git commit -m "ðŸ”„ Auto-update AkashGO data $(date)" || echo "No changes to commit"
          git push
